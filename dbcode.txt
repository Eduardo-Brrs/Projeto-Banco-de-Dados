CREATE SCHEMA IF NOT EXISTS petvida;

SET search_path TO petvida;

CREATE TABLE IF NOT EXISTS dono (
    id_dono    SERIAL PRIMARY KEY,
    nome       VARCHAR(120) NOT NULL,
    cpf        VARCHAR(20)  NOT NULL UNIQUE,
    email      VARCHAR(120),
    endereco   VARCHAR(200) NOT NULL,
    telefone   VARCHAR(30)  NOT NULL,
    observacao TEXT,
    criado_em  TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS usuario (
    id_usuario         SERIAL PRIMARY KEY,
    username           VARCHAR(50) UNIQUE NOT NULL,
    senha_cripto       VARCHAR(255) NOT NULL,
    tipo               VARCHAR(20)  NOT NULL,
    id_dono            INT REFERENCES dono(id_dono),
    tentativas_erradas INT DEFAULT 0,
    bloqueado          BOOLEAN DEFAULT FALSE,
    criado_em          TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS animal (
    id_animal SERIAL PRIMARY KEY,
    nome      VARCHAR(120) NOT NULL,
    especie   VARCHAR(60)  NOT NULL,
    raca      VARCHAR(80)  NOT NULL,
    idade     INT          NOT NULL,
    id_dono   INT NOT NULL REFERENCES dono(id_dono) ON DELETE CASCADE,
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS consulta (
    id_consulta  SERIAL PRIMARY KEY,
    data         DATE NOT NULL,
    horario      TIME NOT NULL,
    motivo       VARCHAR(200) NOT NULL,
    diagnostico  VARCHAR(400),
    status       VARCHAR(20) DEFAULT 'agendada',
    prioridade   VARCHAR(20) DEFAULT 'normal',
    id_animal    INT NOT NULL REFERENCES animal(id_animal) ON DELETE CASCADE,
    id_vet       INT REFERENCES usuario(id_usuario),
    criado_em    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS cirurgia (
    id_cirurgia   SERIAL PRIMARY KEY,
    data          DATE NOT NULL,
    tipo_cirurgia VARCHAR(120) NOT NULL,
    observacoes   VARCHAR(500),
    status        VARCHAR(20) DEFAULT 'agendada',
    id_animal     INT NOT NULL REFERENCES animal(id_animal) ON DELETE CASCADE,
    criado_em     TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


ALTER TABLE consulta 
ADD COLUMN IF NOT EXISTS status VARCHAR(20) DEFAULT 'agendada';

ALTER TABLE consulta 
ADD COLUMN IF NOT EXISTS prioridade VARCHAR(20) DEFAULT 'normal';

ALTER TABLE usuario 
ADD COLUMN IF NOT EXISTS senha_cripto VARCHAR(255);

ALTER TABLE dono 
ADD COLUMN IF NOT EXISTS observacao TEXT;

ALTER TABLE usuario 
ADD COLUMN IF NOT EXISTS tentativas_erradas INT DEFAULT 0;

ALTER TABLE usuario 
ADD COLUMN IF NOT EXISTS bloqueado BOOLEAN DEFAULT FALSE;

CREATE INDEX IF NOT EXISTS idx_dono_cpf 
ON dono(cpf);

CREATE INDEX IF NOT EXISTS idx_usuario_username 
ON usuario(username);

CREATE INDEX IF NOT EXISTS idx_animal_dono 
ON animal(id_dono);

CREATE INDEX IF NOT EXISTS idx_consulta_data 
ON consulta(data);

CREATE INDEX IF NOT EXISTS idx_cirurgia_data 
ON cirurgia(data);

SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'petvida';
